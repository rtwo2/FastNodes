name: FastNodes - Main Collector (Fast & Smart)

on:
  schedule:
    - cron: '0 */2 * * *'          # Every 2 hours
  workflow_dispatch:

jobs:
  Collect:
    runs-on: ubuntu-latest
    timeout-minutes: 480

    env:
      SingboxPath: sing-box
      Sources: |
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Original sources (AvenCores + Proxify + others)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/1.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/2.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/3.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/4.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/5.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/6.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/7.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/8.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/9.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/10.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/11.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/12.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/13.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/14.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/15.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/16.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/17.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/18.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/19.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/20.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/21.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/22.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/23.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/24.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/25.txt
        https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/26.txt
        https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/v2ray/all_sub.txt
        https://raw.githubusercontent.com/roosterkid/openproxylist/main/V2RAY_RAW.txt
        https://raw.githubusercontent.com/ebrasha/free-v2ray-public-list/refs/heads/main/all_extracted_configs.txt
        https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/All_Configs_Sub.txt
        https://raw.githubusercontent.com/barry-far/V2ray-config/main/All_Configs_Sub.txt
        https://raw.githubusercontent.com/roosterkid/openproxylist/refs/heads/main/V2RAY.txt
        https://raw.githubusercontent.com/ShatakVPN/ConfigForge-V2Ray/main/configs/all.txt
        https://raw.githubusercontent.com/miladtahanian/V2RayCFGDumper/refs/heads/main/sub.txt
        https://raw.githubusercontent.com/Delta-Kronecker/V2ray-Config/refs/heads/main/sub.txt
        https://raw.githubusercontent.com/mostafasadeghifar/v2ray-config/main/config_file.txt
        https://raw.githubusercontent.com/liMilCo/v2r/main/all_configs.txt
        # Proxify mixed (38 files)
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-1.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-2.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-3.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-4.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-5.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-6.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-7.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-8.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-9.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-10.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-11.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-12.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-13.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-14.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-15.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-16.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-17.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-18.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-19.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-20.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-21.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-22.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-23.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-24.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-25.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-26.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-27.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-28.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-29.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-30.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-31.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-32.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-33.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-34.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-35.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-36.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-37.txt
        https://raw.githubusercontent.com/Firmfox/Proxify/refs/heads/main/v2ray_configs/mixed/subscription-38.txt

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # New sources â€” GitHub / Bitbucket / others (2026)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        https://raw.githubusercontent.com/mermeroo/Loon/main/node
        https://raw.githubusercontent.com/mermeroo/Loon/main/node%202
        https://raw.githubusercontent.com/mermeroo/Clash-V2ray/main/v2ray
        https://raw.githubusercontent.com/mermeroo/QX/refs/heads/main/Nodes
        https://raw.githubusercontent.com/mermeroo/Loon/refs/heads/main/all.nodes.txt
        https://raw.githubusercontent.com/mermeroo/QuantumultX/refs/heads/main/Trojan.nodes
        https://raw.githubusercontent.com/personqianduixue/SubCrawler/main/sub/share/all
        https://raw.githubusercontent.com/w1770946466/Auto_proxy/main/Long_term_subscription_num
        https://raw.githubusercontent.com/mahdibland/ShadowsocksAggregator/master/sub/sub_merge.txt
        https://raw.githubusercontent.com/mahdibland/V2RayAggregator/master/sub/sub_merge.txt
        https://raw.githubusercontent.com/Leon406/SubCrawler/main/sub/share/all3
        https://raw.githubusercontent.com/gtang8/SubCrawler/main/sub/share/all
        https://raw.githubusercontent.com/zzz6839/SubCrawler/main/sub/share/all
        https://raw.githubusercontent.com/zjfb/SubCrawler/main/sub/share/all
        https://raw.githubusercontent.com/QQnight/SubCrawler/main/sub/share/all
        https://raw.githubusercontent.com/mheidari98/.proxy/main/all
        https://bitbucket.org/huwo1/proxy_nodes/raw/f31ca9ec67b84071515729ff45b011b6b09c10f2/ss.md
        https://bitbucket.org/huwo1/proxy_nodes/raw/f31ca9ec67b84071515729ff45b011b6b09c10f2/vmess.md
        https://bitbucket.org/huwo1/proxy_nodes/raw/f31ca9ec67b84071515729ff45b011b6b09c10f2/proxy.md
        https://bitbucket.org/huwo1/proxy_nodes/raw/f31ca9ec67b84071515729ff45b011b6b09c10f2/trojan.md
        https://raw.githubusercontent.com/mermeroo/telegram-configs-collector/main/protocols/tuic
        https://raw.githubusercontent.com/mermeroo/telegram-configs-collector/main/protocols/hysteria
        https://raw.githubusercontent.com/mermeroo/telegram-configs-collector/main/protocols/juicity
        https://raw.githubusercontent.com/mermeroo/free-v2ray-collector/main/main/mix
        https://raw.githubusercontent.com/mermeroo/free-v2ray-collector/main/main/reality
        https://raw.githubusercontent.com/mermeroo/free-v2ray-collector/main/main/shadowsocks
        https://raw.githubusercontent.com/mermeroo/free-v2ray-collector/main/main/trojan
        https://raw.githubusercontent.com/mermeroo/free-v2ray-collector/main/main/vless
        https://raw.githubusercontent.com/mermeroo/free-v2ray-collector/main/main/vmess
        https://raw.githubusercontent.com/soroushmirzaei/telegram-configs-collector/main/protocols/tuic
        https://raw.githubusercontent.com/soroushmirzaei/telegram-configs-collector/main/protocols/hysteria
        https://raw.githubusercontent.com/soroushmirzaei/telegram-configs-collector/main/protocols/juicity
        https://raw.githubusercontent.com/yebekhe/TelegramV2rayCollector/main/sub/normal/hysteria2
        https://raw.githubusercontent.com/yebekhe/TelegramV2rayCollector/main/sub/normal/tuic
        https://raw.githubusercontent.com/barry-far/V2ray-Configs/refs/heads/main/Splitted-By-Protocol/hysteria2.txt
        https://raw.githubusercontent.com/Epodonios/v2ray-configs/main/Splitted-By-Protocol/hysteria2.txt
        https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/filtered/subs/hy2.txt
        https://raw.githubusercontent.com/MatinGhanbari/v2ray-configs/main/subscriptions/filtered/subs/tuic.txt

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # Clash YAML heavy sources (most should parse)
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        https://raw.githubusercontent.com/tbbatbb/Proxy/master/dist/clash.config.yaml
        https://raw.githubusercontent.com/ermaozi/get_subscribe/main/subscribe/clash.yml
        https://raw.githubusercontent.com/zhangkaiitugithub/passcro/main/speednodes.yaml
        https://raw.githubusercontent.com/vveg26/get_proxy/main/dist/clash.config.yaml
        https://raw.githubusercontent.com/vveg26/chromego_merge/main/sub/merged_proxies.yaml
        https://raw.githubusercontent.com/ronghuaxueleng/get_v2/main/pub/changfengoss.yaml
        https://raw.githubusercontent.com/ronghuaxueleng/get_v2/main/pub/combine.yaml
        https://raw.githubusercontent.com/itxve/fetch-clash-node/main/node/ClashNode.yaml
        https://raw.githubusercontent.com/igeekshare/GeekshareFreeNode/main/clash/Geekshare.yaml
        https://raw.githubusercontent.com/learnhard-cn/free_proxy_ss/main/clash/clash.provider.yaml
        https://raw.githubusercontent.com/learnhard-cn/free_proxy_ss/main/clash/config.yaml
        https://raw.githubusercontent.com/oslook/clash-freenode/main/clash.yaml
        https://raw.githubusercontent.com/anaer/Sub/main/clash.yaml
        https://raw.githubusercontent.com/aiboboxx/clashfree/main/clash.yml
        https://raw.githubusercontent.com/rxsweet/proxies/main/sub/rx.yaml
        https://raw.githubusercontent.com/rxsweet/proxies/main/sub/srx.yaml
        https://raw.githubusercontent.com/rxsweet/proxies/main/sub/free.yaml
        https://raw.githubusercontent.com/Barabama/FreeNodes/refs/heads/main/nodes/clashmeta.yaml
        https://raw.githubusercontent.com/lagzian/SS-Collector/main/mix_clash.yaml
        https://raw.githubusercontent.com/Misaka-blog/chromego_merge/main/sub/merged_proxies_new.yaml

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # V2Ray / base64 heavy sources
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        https://raw.githubusercontent.com/w1770946466/Auto_proxy/main/Long_term_subscription_num
        https://raw.githubusercontent.com/adiwzx/freenode/main/adispeed.txt
        https://raw.githubusercontent.com/Pawdroid/Free-servers/main/sub
        https://raw.githubusercontent.com/vxiaov/free_proxy_ss/main/v2ray/v2raysub
        https://raw.githubusercontent.com/ALIILAPRO/v2rayNG-Config/main/sub.txt
        https://raw.githubusercontent.com/MrMohebi/xray-proxy-grabber-telegram/master/collected-proxies/row-url/all.txt
        https://raw.githubusercontent.com/yebekhe/TelegramV2rayCollector/main/sub/normal/vless
        https://raw.githubusercontent.com/yebekhe/TelegramV2rayCollector/main/sub/normal/vmess
        https://raw.githubusercontent.com/MhdiTaheri/V2rayCollector/main/sub/mix

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download fresh GeoIP database ğŸŒ
        run: |
          echo "Downloading fresh country database..."
          if curl -fsSL "https://git.io/GeoLite2-Country.mmdb" -o ProxyCollector/Country.mmdb; then
            echo "âœ… Success! Fresh GeoIP database downloaded."
            ls -la ProxyCollector/Country.mmdb
          else
            echo "âš ï¸ Download failed - keeping previous file if exists"
            ls -la ProxyCollector/Country.mmdb || echo "No GeoIP file yet"
          fi

      - name: Download fresh FireHOL Level 2 blacklist ğŸ”’
        run: |
          echo "Downloading fresh FireHOL Level 2 blacklist..."
          BLACKLIST_URL="https://iplists.firehol.org/files/firehol_level2.netset"
          if curl -fsSL "$BLACKLIST_URL" -o ProxyCollector/blacklist.netset; then
            echo "âœ… Success! Fresh Level 2 blacklist downloaded."
            wc -l ProxyCollector/blacklist.netset | awk '{print "Lines in blacklist: " $1}'
          else
            echo "âš ï¸ Download failed - keeping previous"
            wc -l ProxyCollector/blacklist.netset || echo "No blacklist yet"
          fi

      - name: Setup .NET environment
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Restore project dependencies
        run: dotnet restore ProxyCollector/ProxyCollector.csproj

      - name: Cache sing-box (faster startup)
        uses: actions/cache@v4
        with:
          path: ~/sing-box-cache/sing-box
          key: sing-box-v1.10.6-Linux-v4

      - name: Install sing-box if needed
        run: |
          mkdir -p ~/sing-box-cache
          if [ ! -f ~/sing-box-cache/sing-box ]; then
            echo "Installing fresh sing-box..."
            curl -fsSLO https://github.com/SagerNet/sing-box/releases/download/v1.10.6/sing-box_1.10.6_linux_amd64.deb
            sudo dpkg -i sing-box_1.10.6_linux_amd64.deb
            sudo apt-get install -f
            cp /usr/bin/sing-box ~/sing-box-cache/sing-box
          else
            echo "Using cached sing-box"
            sudo cp ~/sing-box-cache/sing-box /usr/bin/sing-box
            sudo chmod +x /usr/bin/sing-box
          fi

      - name: Run ProxyCollector (Collect + Rename + Best Results)
        run: dotnet run --configuration Release --project ProxyCollector

      - name: Show quick stats ğŸ“Š
        run: |
          echo "Quick stats:"
          wc -l sub/everything.txt | awk '{print "everything.txt lines: " $1}'
          wc -l sub/Best-Results/top500.txt | awk '{print "top500.txt lines: " $1}'
          ls -lh sub/protocols/ | grep ".txt" || echo "No protocol txt files"
          ls -lh sub/temp/ || echo "Temp folder empty?"

      - name: Commit & push updated files ğŸ“¦
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          git stash push -u -m "Stash before pull" || true
          
          git fetch origin
          git pull --rebase origin main || true
          
          git stash pop || true
          
          git add ProxyCollector/Country.mmdb ProxyCollector/blacklist.netset sub/ || true
          
          git commit -m "Fresh proxies + GeoIP + blacklist + Best Results (top 500) - $(date +'%Y-%m-%d %H:%M UTC') - $(wc -l < sub/everything.txt) proxies - temp backup included" --allow-empty || echo "Nothing new to commit"
          
          git push --force-with-lease origin main || echo "Push failed (check repo settings â†’ Actions â†’ Workflow permissions â†’ must be 'Read and write')"
