name: Collect & Test Proxies (FastNodes)

on:
  schedule:
    - cron: '0 */3 * * *'  # every 3 hours
  workflow_dispatch:       # This enables the "Run workflow" button

jobs:
  Collect:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        # NO repository: or token: here — let it use the default (current repo)

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Cache sing-box
        uses: actions/cache@v4
        id: cache-singbox
        with:
          path: ~/sing-box-cache/sing-box
          key: sing-box-v1.10.6-Linux-v4

      - name: Install or restore sing-box
        run: |
          mkdir -p ~/sing-box-cache
          if [ ! -f ~/sing-box-cache/sing-box ]; then
            echo "Installing fresh sing-box..."
            curl -fsSLO https://github.com/SagerNet/sing-box/releases/download/v1.10.6/sing-box_1.10.6_linux_amd64.deb
            sudo dpkg -i sing-box_1.10.6_linux_amd64.deb
            sudo apt-get install -f
            cp /usr/bin/sing-box ~/sing-box-cache/sing-box
          else
            echo "Using cached sing-box"
            sudo cp ~/sing-box-cache/sing-box /usr/bin/sing-box
            sudo chmod +x /usr/bin/sing-box
          fi

      - name: Download fresh GeoIP database
        run: |
          echo "Downloading fresh country database..."
          if curl -fsSL "https://git.io/GeoLite2-Country.mmdb" -o ProxyCollector/Country.mmdb; then
            echo "✅ Success! Fresh GeoIP database downloaded."
            ls -la ProxyCollector/Country.mmdb
          else
            echo "⚠️ Download failed - keeping previous file if exists"
            ls -la ProxyCollector/Country.mmdb || echo "No GeoIP file yet"
          fi

      - name: Download fresh FireHOL Level 1 blacklist
        run: |
          echo "Downloading fresh FireHOL Level 1 blacklist..."
          BLACKLIST_URL="https://iplists.firehol.org/files/firehol_level1.netset"
          if curl -fsSL "$BLACKLIST_URL" -o ProxyCollector/blacklist.netset; then
            echo "✅ Success! Fresh Level 1 blacklist downloaded."
            wc -l ProxyCollector/blacklist.netset | awk '{print "Lines in blacklist: " $1}'
          else
            echo "⚠️ Download failed - keeping previous"
            wc -l ProxyCollector/blacklist.netset || echo "No blacklist yet"
          fi

      - name: Restore & run ProxyCollector
        env:
          SingboxPath: sing-box
          Sources: |
            # (your full long list of sources here — keep exactly as you have it)
            https://raw.githubusercontent.com/AvenCores/goida-vpn-configs/refs/heads/main/githubmirror/1.txt
            # ... all the rest ...

        run: dotnet run --configuration Release --project ProxyCollector

      - name: Commit & push results
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Explicitly add only final important files/folders - exclude sub/temp/
          git add ProxyCollector/Country.mmdb \
                  ProxyCollector/blacklist.netset \
                  ProxyCollector/bogons.txt \
                  sub/everything.txt \
                  sub/everything.json \
                  sub/protocols/ \
                  sub/countries/ \
                  sub/Best-Results/
          
          git commit -m "Fresh proxies + GeoIP + blacklist + Best Results - $(date +'%Y-%m-%d %H:%M UTC') - $(wc -l < sub/everything.txt) proxies" --allow-empty || echo "Nothing new to commit"
          
          git push origin main || echo "Push failed"
